%html
    %head
        %link{:type => 'text/css', :href => '/site.css', :rel => 'stylesheet'}
        %script{:src => 'jquery-1.3.2.min.js', :type => 'text/javascript'}
        :javascript
            var currentTurn = 'x'

            function whosNext() {
                if (currentTurn == 'x')
                    return 'o'
                else
                    return 'x'
            }

            function setupTurn(marker) {
                currentTurn = marker
                $('#message').html('<img src="/place' + marker + '.png"/>')
            }

            function getCellUpdater(cell, marker) {
                return function updateCellContents(data) {
                    if (data[0] == 'ok') {
                        $(cell).html('<img src="/' + marker + '.png"/>')
                        setupTurn(whosNext())
                    } else if (data[0] == 'game-over') {
                        $(cell).html('<img src="/' + marker + '.png"/>')
                        $('#message').html(data[1] + " has won!")
                    }
                }
            }

            function clickCell(cell) {
                jQuery.post('/play',
                            {marker: currentTurn, index: cell.id.replace('cell', '')},
                            getCellUpdater(cell, currentTurn),
                            'json')
            }

            $(document).ready(function() {
                jQuery.each ($('.cell'), function(i, val) {
                    $(val).hover(
                        function() {
                            $(val).css('background-color', '#BBBBBB')
                        },
                        function() {
                            $(val).css('background-color', 'white')
                        })
                    $(val).click(
                        function() {
                            clickCell(val)
                        })
                })
                setupTurn('x')
            })
    %body
        - board.each do |cell, type, id|
            %div{:id => id, :class => (type << 'cell').join(' ') }
                = image_for_cell(cell)

        #message.clearing
